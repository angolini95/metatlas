<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>metatlas.metatlas_objects &#8212; Metatlas 0.7 documentation</title>
    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootswatch-3.3.6/cosmo/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">
  
  


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          Metatlas</a>
        <span class="navbar-text navbar-version pull-left"><b>0.7</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/api/metatlas.html"><code class="docutils literal"><span class="pre">metatlas</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/info.html">Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/info.html#data-model">Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/info.html#provenance-model">Provenance Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/info.html#visualization">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/admin.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/admin.html#nersc">NERSC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/admin.html#mysql">MySQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/admin.html#cron">CRON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/admin.html#anaconda">Anaconda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/admin.html#r-packages">R packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/admin.html#rdkit-pacakge-on-debian-ubuntu">RDKIT Pacakge on Debian/Ubuntu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/admin.html#synchronizing-the-repo">Synchronizing the Repo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/admin.html#id1">Administration</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
        </div>
      </div>
    <div class="col-md-9 content">
      
  <h1>Source code for metatlas.metatlas_objects</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">from</span> <span class="nn">pwd</span> <span class="k">import</span> <span class="n">getpwuid</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="k">import</span> <span class="n">tabulate</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">.object_helpers</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">set_docstring</span><span class="p">,</span> <span class="n">Workspace</span><span class="p">,</span> <span class="n">format_timestamp</span><span class="p">,</span> <span class="n">MetList</span><span class="p">,</span>
    <span class="n">MetUnicode</span><span class="p">,</span> <span class="n">MetFloat</span><span class="p">,</span> <span class="n">MetInstance</span><span class="p">,</span> <span class="n">MetInt</span><span class="p">,</span> <span class="n">MetEnum</span><span class="p">,</span> <span class="n">MetBool</span><span class="p">,</span> <span class="n">HasTraits</span><span class="p">,</span>
    <span class="n">Stub</span>
<span class="p">)</span>

<span class="c1">#Making a new table means adding a new class to metatlas_objects.py. </span>
<span class="c1">#Floats are set as single precision by default, unfortunately, so here is the best way to create a table containing floats:</span>
<span class="c1">#Create a new table</span>
<span class="c1">#1) Create a new class in metatlas_objects.py.</span>
<span class="c1">#2) Create a new object of that class and store it.</span>
<span class="c1">#3) Log into database</span>
<span class="c1">#4) Run alter table TABLE_NAME modify COLUMN_NAME double; for each float column</span>
<span class="c1">#Add a floating point object to a new table</span>
<span class="c1">#1) Update the class in metatlas_objects.py.</span>
<span class="c1">#2) Create an object with the updated class and store it.</span>
<span class="c1">#3) Log into database</span>
<span class="c1">#4) Run alter table TABLE_NAME modify COLUMN_NAME double; for each new float column</span>


<span class="c1"># Whether to fetch stubs automatically, disabled when we want to display</span>
<span class="c1"># a large number of objects.</span>
<span class="n">FETCH_STUBS</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">POLARITY</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="s1">&#39;negative&#39;</span><span class="p">,</span> <span class="s1">&#39;alternating&#39;</span><span class="p">)</span>
<span class="n">FRAGMENTATION_TECHNIQUE</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;hcd&#39;</span><span class="p">,</span><span class="s1">&#39;cid&#39;</span><span class="p">,</span><span class="s1">&#39;etd&#39;</span><span class="p">,</span><span class="s1">&#39;ecd&#39;</span><span class="p">,</span><span class="s1">&#39;irmpd&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="retrieve"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.retrieve">[docs]</a><span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">object_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get objects from the Metatlas object database.</span>

<span class="sd">    This will automatically select only objects created by the current</span>
<span class="sd">    user unless `username` is provided. Use `username=&#39;*&#39;` to search</span>
<span class="sd">    against all users.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    object_type: string</span>
<span class="sd">      The type of object to search for (i.e. &quot;Groups&quot;).</span>
<span class="sd">    **kwargs</span>
<span class="sd">      Specific search queries (i.e. name=&quot;Sargasso&quot;).</span>
<span class="sd">      Use &#39;%&#39; for wildcard patterns (i.e. description=&#39;Hello%&#39;).</span>
<span class="sd">      If you want to match a &#39;%&#39; character, use &#39;%%&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    objects: list</span>
<span class="sd">      List of Metatlas Objects meeting the criteria.  Will return the</span>
<span class="sd">      latest version of each object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">workspace</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">object_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.remove">[docs]</a><span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">object_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove objects from the Metatlas object database.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    object_type: string</span>
<span class="sd">      The type of object to remove (i.e. &quot;Groups&quot;).</span>
<span class="sd">    **kwargs</span>
<span class="sd">      Specific search queries (i.e. name=&quot;Sargasso&quot;).</span>
<span class="sd">      Use &#39;%&#39; for wildcard patterns (i.e. description=&#39;Hello%&#39;).</span>
<span class="sd">      If you want to match a &#39;%&#39; character, use &#39;%%&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;remove() expects a string argument, use remove_objects() to&#39;</span>
              <span class="s1">&#39;delete actual objects.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">workspace</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">object_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_objects"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.remove_objects">[docs]</a><span class="k">def</span> <span class="nf">remove_objects</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">all_versions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove objects from the database.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    all_versions: boolean, optional</span>
<span class="sd">        If True, remove all versions of the object sharing the current</span>
<span class="sd">        head_id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;remove_objects() expects actual objects, use remove() to&#39;</span>
              <span class="s1">&#39;remove objects by type.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">workspace</span><span class="o">.</span><span class="n">remove_objects</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">all_versions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="store"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.store">[docs]</a><span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store Metatlas objects in the database.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    objects: Metatlas object or list of Metatlas Objects</span>
<span class="sd">        Object(s) to store in the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workspace</span><span class="o">.</span><span class="n">save_objects</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="nd">@set_docstring</span>
<span class="k">class</span> <span class="nc">MetatlasObject</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="s1">&#39;Untitled&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of the object&#39;</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="s1">&#39;No description&#39;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Description of the object&#39;</span><span class="p">)</span>
    <span class="n">unique_id</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Unique identifier for the object&#39;</span><span class="p">,</span>
                           <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">creation_time</span> <span class="o">=</span> <span class="n">MetInt</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Unix timestamp at object creation&#39;</span><span class="p">,</span>
                           <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Username who created the object&#39;</span><span class="p">,</span>
                          <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">last_modified</span> <span class="o">=</span> <span class="n">MetInt</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Unix timestamp at last object update&#39;</span><span class="p">,</span>
                           <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">prev_uid</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Unique id of previous version&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">head_id</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Unique id of most recent version of this object&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_loopback_guard</span> <span class="o">=</span> <span class="n">MetBool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_changed</span> <span class="o">=</span> <span class="n">MetBool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the default attributes.&quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;head_id&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;unique_id&#39;</span><span class="p">])</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">())</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;creation_time&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;last_modified&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_trait_change</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_update</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">override_user</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the object in the workspace, including child objects.</span>

<span class="sd">        Child objects are stored in their own tables, and Lists of</span>
<span class="sd">        Child objects are captured in link tables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loopback_guard</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># see if we need to create a new object</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">override_user</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">head_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">changed</span><span class="p">,</span> <span class="n">prev_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_uid</span>
            <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prev_uid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loopback_guard</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">changed</span><span class="p">,</span> <span class="n">prev_uid</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new version of this object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        recursive: boolean, optional</span>
<span class="sd">            If true, clone all of the descendant objects as well.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        obj: MetatlasObject</span>
<span class="sd">            Cloned object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="n">trait</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">trait</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;readonly&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">recursive</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">MetList</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">recursive</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">MetInstance</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">prev_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_id</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">head_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_id</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">show_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show a diff of what has changed between this and previous version.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unique_id: optional, string</span>
<span class="sd">            Unique id to compare against (defaults to current entry in db).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">unique_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unique_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_id</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">unique_id</span><span class="o">=</span><span class="n">unique_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No change!&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="n">trait</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">trait</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;readonly&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tname</span><span class="p">)</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">tname</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">MetInstance</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">unique_id</span><span class="p">:</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tname</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">unique_id</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">MetList</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tname</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> items&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">),</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> items&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">==</span> <span class="n">o</span><span class="o">.</span><span class="n">unique_id</span><span class="p">:</span>
                            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tname</span><span class="p">,</span> <span class="s1">&#39;objects changed&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                            <span class="k">break</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">other</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_on_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When the model changes, set the update fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loopback_guard</span> <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trait_names</span><span class="p">())</span>
        <span class="n">names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">n</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">])</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;creation_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span><span class="p">)</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;last_modified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">format_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Automatically resolve stubs on demand.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Stub</span><span class="p">)</span> <span class="ow">and</span> <span class="n">FETCH_STUBS</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">retrieve</span><span class="p">()</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">FETCH_STUBS</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">subvalue</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subvalue</span><span class="p">,</span> <span class="n">Stub</span><span class="p">):</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subvalue</span><span class="o">.</span><span class="n">retrieve</span><span class="p">())</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subvalue</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="Method"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.Method">[docs]</a><span class="k">class</span> <span class="nc">Method</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each LCMS run, a Method is a consistent description of</span>
<span class="sd">    how the sample was prepared and LCMS data was collected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">protocol_ref</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Reference to a published protocol: &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;identical to the protocol used.&#39;</span><span class="p">)</span>
    <span class="n">quenching_method</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Description of the method used to &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;stop metabolism.&#39;</span><span class="p">)</span>
    <span class="n">extraction_solvent</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Solvent or solvent mixture used to &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;extract metabolites.&#39;</span><span class="p">)</span>
    <span class="n">reconstitution_method</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Solvent or solvent mixture &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;the extract is reconstituted in prior to injection for an LCMS Run.&#39;</span><span class="p">)</span>
    <span class="n">mobile_phase_a</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Solvent or solvent mixture.&#39;</span><span class="p">)</span>
    <span class="n">mobile_phase_b</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Solvent or solvent mixture.&#39;</span><span class="p">)</span>
    <span class="n">temporal_parameters</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="s1">&#39;List of temporal changes to the&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;mixing of mobile_phase_a and mobile_phase_b.&#39;</span><span class="p">)</span>
    <span class="c1">#Time = MetList()</span>
    <span class="c1">#Flow = MetList()</span>
    <span class="c1">#A_percent = MetList()</span>
    <span class="c1">#B_percent = MetList()</span>
    <span class="c1">#Chromatography Stack</span>
    <span class="c1">#Model</span>
    <span class="c1">#Serial Number</span>
    <span class="c1">#Modules</span>
    <span class="n">column_model</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Brand and catalog number of the column&#39;</span><span class="p">)</span>
    <span class="n">column_type</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Class of column used.&#39;</span><span class="p">)</span>
    <span class="n">scan_mz_range</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum and &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;maximum mz recorded for a run.&#39;</span><span class="p">)</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Brand and catalog number for the &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;mass spectrometer.&#39;</span><span class="p">)</span>
    <span class="n">ion_source</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Method for ionization.&#39;</span><span class="p">)</span>
    <span class="n">mass_analyzer</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Method for detection.&#39;</span><span class="p">)</span>
    <span class="n">polarity</span> <span class="o">=</span> <span class="n">MetEnum</span><span class="p">(</span><span class="n">POLARITY</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;polarity for the run&#39;</span><span class="p">)</span></div>



<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="Sample"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.Sample">[docs]</a><span class="k">class</span> <span class="nc">Sample</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Sample is the material that is processed with a Method.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="k">def</span> <span class="nf">load_lcms_files</span><span class="p">(</span><span class="n">mzml_files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse mzML files and load them into LcmsRun objects.</span>

<span class="sd">    Note: This should be done automatically for runs in</span>
<span class="sd">    /project/projectdirs/metatlas/raw_data/&lt;username&gt;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mzml_files: list of str</span>
<span class="sd">       List of paths to mzml_files.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    runs: list</span>
<span class="sd">       List of LcmsRun objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">runs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">mzml_files</span><span class="p">:</span>
        <span class="n">hdf5_file</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.mzML&#39;</span><span class="p">,</span> <span class="s1">&#39;.h5&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hdf5_file</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File already exists: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">hdf5_file</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">metatlas</span> <span class="k">import</span> <span class="n">LcmsRun</span><span class="p">,</span> <span class="n">mzml_to_hdf</span>
            <span class="n">hdf_file</span> <span class="o">=</span> <span class="n">mzml_to_hdf</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">st_uid</span><span class="p">)</span><span class="o">.</span><span class="n">pw_name</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">experiment</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">experiment</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">filename</span>
            <span class="n">ctime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">st_ctime</span>
            <span class="n">run</span> <span class="o">=</span> <span class="n">LcmsRun</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                          <span class="n">created_by</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                          <span class="n">modified_by</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                          <span class="n">created</span><span class="o">=</span><span class="n">ctime</span><span class="p">,</span> <span class="n">last_modified</span><span class="o">=</span><span class="n">ctime</span><span class="p">,</span>
                          <span class="n">mzml_file</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">hdf5_file</span><span class="o">=</span><span class="n">hdf_file</span><span class="p">)</span>
            <span class="n">runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">store</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">runs</span>


<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="LcmsRun"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.LcmsRun">[docs]</a><span class="k">class</span> <span class="nc">LcmsRun</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An LCMS run is the reference to a file prepared with liquid</span>
<span class="sd">    chromatography and mass spectrometry.</span>

<span class="sd">    The msconvert program is used to convert raw data (centroided is prefered)</span>
<span class="sd">    to mzML.</span>

<span class="sd">    Note: These objects are not intented to be created directly, but by putting</span>
<span class="sd">    the files in /project/projectdirs/metatlas/raw_data/&lt;username&gt; or by</span>
<span class="sd">    running `load_lcms_files()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">MetInstance</span><span class="p">(</span><span class="n">Method</span><span class="p">)</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;The name of the experiment&#39;</span><span class="p">)</span>
    <span class="n">hdf5_file</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to the HDF5 file at NERSC&#39;</span><span class="p">)</span>
    <span class="n">mzml_file</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to the MZML file at NERSC&#39;</span><span class="p">)</span>
    <span class="n">acquisition_time</span> <span class="o">=</span> <span class="n">MetInt</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Unix timestamp when data was acquired creation&#39;</span><span class="p">)</span>
    <span class="n">injection_volume</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">injection_volume_units</span> <span class="o">=</span> <span class="n">MetEnum</span><span class="p">((</span><span class="s1">&#39;uL&#39;</span><span class="p">,</span> <span class="s1">&#39;nL&#39;</span><span class="p">),</span> <span class="s1">&#39;uL&#39;</span><span class="p">)</span>
    <span class="n">pass_qc</span> <span class="o">=</span> <span class="n">MetBool</span><span class="p">(</span><span class="n">help</span><span class="o">=</span> <span class="s1">&#39;True/False for if the LCMS Run has passed a quality control assessment&#39;</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">MetInstance</span><span class="p">(</span><span class="n">Sample</span><span class="p">)</span></div>


<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="FunctionalSet"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.FunctionalSet">[docs]</a><span class="k">class</span> <span class="nc">FunctionalSet</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Functional sets of compounds.  For example set called &quot;hexose&quot; would</span>
<span class="sd">    include &quot;glucose, galactose, etc&quot;.  Functional sets can be sets-of-sets.</span>
<span class="sd">    &quot;Sugars&quot; would be a set that contains &quot;Hexoses&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">enabled</span> <span class="o">=</span> <span class="n">MetBool</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">members</span> <span class="o">=</span> <span class="n">MetList</span><span class="p">(</span><span class="n">MetInstance</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">))</span></div>


<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="Compound"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.Compound">[docs]</a><span class="k">class</span> <span class="nc">Compound</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Compound is a structurally distinct entry.  The majority of MetAtlas compounds are from a merge</span>
<span class="sd">    of WikiData, miBIG, HMDB, ChEBI, LipidMaps, MetaCyc, GNPS, ENZO-Library, MSMLS-Library.  Compounds that </span>
<span class="sd">    had an unparseable structural identifier by RDKIT June, 2016, were ignored.  Distinct molecules are found</span>
<span class="sd">    by inchi-key of neutralized and de-salted molecules.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#name is inherited by all metatlas objects and is the most commonly used name for each compound</span>
    <span class="c1">#Description is a short text description of the compound</span>
    <span class="n">iupac_name</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;IUPAC International Chemical Identifier, optional&#39;</span><span class="p">)</span>
    <span class="n">synonyms</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">source</span><span class="o">=</span><span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">chebi_id</span><span class="o">=</span><span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">hmdb_id</span><span class="o">=</span><span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">img_abc_id</span><span class="o">=</span><span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">kegg_id</span><span class="o">=</span><span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">lipidmaps_id</span><span class="o">=</span><span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">metacyc_id</span><span class="o">=</span><span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">pubchem_compound_id</span><span class="o">=</span><span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">pubchem_url</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Reference database table url&#39;</span><span class="p">)</span>
    <span class="n">wikipedia_url</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Reference database table url&#39;</span><span class="p">)</span>
    <span class="n">kegg_url</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Reference database table url&#39;</span><span class="p">)</span>
    <span class="n">hmdb_url</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Reference database table url&#39;</span><span class="p">)</span>
    <span class="n">chebi_url</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Reference database table url&#39;</span><span class="p">)</span>
    <span class="n">lipidmaps_url</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Reference database table url&#39;</span><span class="p">)</span>
    
    <span class="c1">#RDKIT Calculates these with some helper functions</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">mono_isotopic_molecular_weight</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">permanent_charge</span> <span class="o">=</span> <span class="n">MetInt</span><span class="p">()</span>
    <span class="n">number_components</span> <span class="o">=</span> <span class="n">MetInt</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Must be one or greater&#39;</span><span class="p">)</span>
    <span class="n">num_free_radicals</span> <span class="o">=</span> <span class="n">MetInt</span><span class="p">()</span>
    <span class="n">inchi</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">inchi_key</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">neutralized_inchi</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">neutralized_inchi_key</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">neutralized_2d_inchi</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">()</span>
    <span class="n">neutralized_2d_inchi_key</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">()</span></div>
    
    <span class="c1">#reference_xrefs = MetList(MetInstance(ReferenceDatabase),</span>
    <span class="c1">#                       help=&#39;Tag a compound with compound ids from &#39; +</span>
    <span class="c1">#                            &#39;external databases&#39;)</span>
    <span class="c1">#functional_sets = MetList(MetInstance(FunctionalSet))</span>


<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="Reference"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.Reference">[docs]</a><span class="k">class</span> <span class="nc">Reference</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Place holder for future reference sources.</span>
<span class="sd">    We expect many in silico methods will soon be robust enough to suggest</span>
<span class="sd">    retention times, m/z, and fragmentation.</span>
<span class="sd">    Pactolus is a great example of this.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lcms_run</span> <span class="o">=</span> <span class="n">MetInstance</span><span class="p">(</span><span class="n">LcmsRun</span><span class="p">)</span>
    <span class="n">enabled</span> <span class="o">=</span> <span class="n">MetBool</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ref_type</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;The type of reference&#39;</span><span class="p">)</span></div>


<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="IdentificationGrade"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.IdentificationGrade">[docs]</a><span class="k">class</span> <span class="nc">IdentificationGrade</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Each CompoundIdentification will have an identification_grade</span>
<span class="sd">    Identification Grades:</span>
<span class="sd">    1) High intensity and verifiable by MSMS and RT</span>
<span class="sd">    authentic standard</span>
<span class="sd">    2) Verifiable by MSMS from database or</span>
<span class="sd">    publication</span>
<span class="sd">    3) Has fragment ion or neutral loss characteristic</span>
<span class="sd">    of a class of compounds</span>
<span class="sd">    4) definitive chemical formula and adduct</span>
<span class="sd">    5) Significant changing metabolite with MSMS</span>
<span class="sd">    suggestion from MIDAS</span>
<span class="sd">    6) Significant changing metabolite</span>
<span class="sd">    7) Not Significant changing metabolite with</span>
<span class="sd">    MSMS suggestion from MIDAS</span>
<span class="sd">    8) Not Significant changing metabolite</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="n">ID_GRADES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_IdGradeTrait</span><span class="p">(</span><span class="n">MetInstance</span><span class="p">):</span>

    <span class="n">klass</span> <span class="o">=</span> <span class="n">IdentificationGrade</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">ID_GRADES</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ID_GRADES</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ID_GRADES</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
            <span class="n">objects</span> <span class="o">=</span> <span class="n">workspace</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="s1">&#39;identificationgrade&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">objects</span><span class="p">:</span>
                <span class="n">ID_GRADES</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">objects</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="Group"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.Group">[docs]</a><span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Group can be a:</span>
<span class="sd">    file,</span>
<span class="sd">    group of files, or</span>
<span class="sd">    group of groups</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">MetList</span><span class="p">(</span><span class="n">MetInstance</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">),</span>
                 <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Can contain other groups or LCMS Runs&#39;</span><span class="p">)</span></div>



    
<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="MzIntensityPair"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.MzIntensityPair">[docs]</a><span class="k">class</span> <span class="nc">MzIntensityPair</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="n">mz</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span></div>


<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="FragmentationReference"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.FragmentationReference">[docs]</a><span class="k">class</span> <span class="nc">FragmentationReference</span><span class="p">(</span><span class="n">Reference</span><span class="p">):</span>
    <span class="c1">#This is specific for storing MS2 fragmentation spectra</span>
    <span class="c1">#A Fragmentation Tree will be added as a datatype when MS^n is deposited</span>
    <span class="n">polarity</span> <span class="o">=</span> <span class="n">MetEnum</span><span class="p">(</span><span class="n">POLARITY</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">)</span>
    <span class="n">precursor_mz</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">collision_energy</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">technique</span> <span class="o">=</span> <span class="n">MetEnum</span><span class="p">(</span><span class="n">FRAGMENTATION_TECHNIQUE</span><span class="p">,</span><span class="s1">&#39;cid&#39;</span><span class="p">)</span>
    <span class="n">mz_intensities</span> <span class="o">=</span> <span class="n">MetList</span><span class="p">(</span><span class="n">MetInstance</span><span class="p">(</span><span class="n">MzIntensityPair</span><span class="p">),</span>
                          <span class="n">help</span><span class="o">=</span><span class="s1">&#39;list of [mz, intesity] tuples that describe &#39;</span> <span class="o">+</span>
                               <span class="s1">&#39; a fragmentation spectra&#39;</span><span class="p">)</span></div>


<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="RtReference"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.RtReference">[docs]</a><span class="k">class</span> <span class="nc">RtReference</span><span class="p">(</span><span class="n">Reference</span><span class="p">):</span>
    <span class="n">rt_peak</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">rt_min</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">rt_max</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">rt_units</span> <span class="o">=</span> <span class="n">MetEnum</span><span class="p">((</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">),</span> <span class="s1">&#39;sec&#39;</span><span class="p">)</span></div>


<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="MzReference"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.MzReference">[docs]</a><span class="k">class</span> <span class="nc">MzReference</span><span class="p">(</span><span class="n">Reference</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Source of the assertion that a compound has a given m/z and</span>
<span class="sd">    other properties directly tied to m/z.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mz</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">mz_tolerance</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">mz_tolerance_units</span> <span class="o">=</span> <span class="n">MetEnum</span><span class="p">((</span><span class="s1">&#39;ppm&#39;</span><span class="p">,</span> <span class="s1">&#39;Da&#39;</span><span class="p">),</span> <span class="s1">&#39;ppm&#39;</span><span class="p">)</span>
    <span class="n">detected_polarity</span> <span class="o">=</span> <span class="n">MetEnum</span><span class="p">(</span><span class="n">POLARITY</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">)</span>
    <span class="n">adduct</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Optional adduct&#39;</span><span class="p">)</span>
    <span class="n">modification</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Optional modification&#39;</span><span class="p">)</span>
    <span class="n">observed_formula</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Optional observed formula&#39;</span><span class="p">)</span></div>

<span class="nd">@set_docstring</span>
<span class="k">class</span> <span class="nc">IntensityReference</span><span class="p">(</span><span class="n">Reference</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Source of the assertion that a compound has a given m/z and</span>
<span class="sd">    other properties directly tied to m/z.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">peak_height</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">peak_area</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">()</span>
    <span class="n">amount_units</span> <span class="o">=</span> <span class="n">MetEnum</span><span class="p">((</span><span class="s1">&#39;nmol&#39;</span><span class="p">,</span> <span class="s1">&#39;mol&#39;</span><span class="p">),</span> <span class="s1">&#39;nmol&#39;</span><span class="p">)</span>

<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="CompoundIdentification"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.CompoundIdentification">[docs]</a><span class="k">class</span> <span class="nc">CompoundIdentification</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CompoundIdentification links multiple sources of evidence about a</span>
<span class="sd">    compound&#39;s identity to an Atlas.&quot;&quot;&quot;</span>
    <span class="n">compound</span> <span class="o">=</span> <span class="n">MetList</span><span class="p">(</span><span class="n">MetInstance</span><span class="p">(</span><span class="n">Compound</span><span class="p">))</span>
    <span class="n">identification_grade</span> <span class="o">=</span> <span class="n">_IdGradeTrait</span><span class="p">(</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Identification grade of the id (can be specified by a letter A-H&#39;</span>
    <span class="p">)</span>
    <span class="n">mz_references</span> <span class="o">=</span> <span class="n">MetList</span><span class="p">(</span><span class="n">MetInstance</span><span class="p">(</span><span class="n">MzReference</span><span class="p">))</span>
    <span class="n">rt_references</span> <span class="o">=</span> <span class="n">MetList</span><span class="p">(</span><span class="n">MetInstance</span><span class="p">(</span><span class="n">RtReference</span><span class="p">))</span>
    <span class="n">frag_references</span> <span class="o">=</span> <span class="n">MetList</span><span class="p">(</span><span class="n">MetInstance</span><span class="p">(</span><span class="n">FragmentationReference</span><span class="p">))</span>
    <span class="n">intensity_references</span> <span class="o">=</span> <span class="n">MetList</span><span class="p">(</span><span class="n">MetInstance</span><span class="p">(</span><span class="n">IntensityReference</span><span class="p">))</span></div>


<span class="nd">@set_docstring</span>
<div class="viewcode-block" id="Atlas"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.Atlas">[docs]</a><span class="k">class</span> <span class="nc">Atlas</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An atlas contains many compound_ids.&quot;&quot;&quot;</span>
    <span class="n">compound_identifications</span> <span class="o">=</span> <span class="n">MetList</span><span class="p">(</span>
        <span class="n">MetInstance</span><span class="p">(</span><span class="n">CompoundIdentification</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;List of Compound Identification objects&#39;</span><span class="p">)</span></div>


<span class="c1"># @set_docstring</span>
<span class="c1"># class SampleSet(MetatlasObject):</span>
<span class="c1">#     lcmsruns = MetList(MetInstance(LcmsRun))</span>



<span class="nd">@set_docstring</span>
<span class="k">class</span> <span class="nc">MZMineTask</span><span class="p">(</span><span class="n">MetatlasObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a collection of lcms runs, perform untargeted analysis with a scriptable binary</span>
<span class="sd">    Store the run parameters in the database for reuse later</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lcmsruns</span> <span class="o">=</span> <span class="n">MetList</span><span class="p">(</span><span class="n">MetInstance</span><span class="p">(</span><span class="n">LcmsRun</span><span class="p">))</span>
    <span class="n">output_csv</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to the output csv file at NERSC&#39;</span><span class="p">)</span>
    <span class="n">output_project</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to the output project file at NERSC&#39;</span><span class="p">)</span>
    <span class="n">input_xml</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to the input xml file at NERSC&#39;</span><span class="p">)</span>
    <span class="n">input_xml_text</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Text of the batch xml file&#39;</span><span class="p">)</span>

    <span class="n">mz_tolerance</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">(</span><span class="mf">8.0</span><span class="p">)</span>
    <span class="n">mz_tolerance_units</span> <span class="o">=</span> <span class="n">MetEnum</span><span class="p">((</span><span class="s1">&#39;ppm&#39;</span><span class="p">,</span> <span class="s1">&#39;Da&#39;</span><span class="p">),</span> <span class="s1">&#39;ppm&#39;</span><span class="p">)</span>
    <span class="n">polarity</span> <span class="o">=</span> <span class="n">MetEnum</span><span class="p">(</span><span class="n">POLARITY</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">)</span>

    <span class="n">min_peak_duration</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">(</span><span class="mf">0.015</span><span class="p">)</span>
    <span class="n">max_peak_duration</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">rt_tol_perfile</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">(</span><span class="mf">0.015</span><span class="p">)</span>
    <span class="n">rt_tol_multifile</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">rt_units</span> <span class="o">=</span> <span class="n">MetEnum</span><span class="p">((</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">),</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span>

    <span class="n">noise_floor</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">(</span><span class="mf">40000.0</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Signals below this value are not considered&#39;</span><span class="p">)</span>
    <span class="n">min_peak_height</span> <span class="o">=</span> <span class="n">MetFloat</span><span class="p">(</span><span class="mf">100000.0</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;max of eic must be at least this big&#39;</span><span class="p">)</span>
    
    <span class="n">mzmine_launcher</span> <span class="o">=</span> <span class="n">MetUnicode</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to the shell script that launches mzmine file at NERSC&#39;</span><span class="p">)</span>

<span class="c1"># @set_docstring</span>
<span class="c1"># class PactolusTask(MetatlasObject):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     For an LCMS Run, search its msms spectra against pactolus trees</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     lcmsrun = MetInstance(LcmsRun)</span>
<span class="c1">#     output_file = MetUnicode(help=&#39;Path to the output hdf5 file at NERSC&#39;)</span>
<span class="c1">#     input_file = MetUnicode(help=&#39;Path to the input hdf5 container file at NERSC&#39;)</span>
<span class="c1">#     mz_tol = MetFloat(help=&#39;mz tolerance in Daltons&#39;)</span>
<span class="c1">#     polarity = MetEnum(POLARITY, &#39;positive&#39;)</span>
<span class="c1">#     min_intensity = MetFloat(help=&#39;minimum precursor ion intensity&#39;)</span>
<span class="c1">#     pactolus_tree_directory = MetUnicode(help=&#39;Path to the directory containing pactolus trees at NERSC&#39;)</span>
<span class="c1">#     pactolus_launcher = MetUnicode(help=&#39;Path to the shell script that launches pactolus search at NERSC&#39;)</span>

<span class="k">def</span> <span class="nf">find_invalid_runs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find invalid runs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">override</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_override&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">override</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">all_runs</span> <span class="o">=</span> <span class="n">retrieve</span><span class="p">(</span><span class="s1">&#39;lcmsruns&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">invalid</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">all_runs</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">hdf5_file</span><span class="p">)</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">mzml_file</span><span class="p">)</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">hdf5_file</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span><span class="p">):</span>
                <span class="n">invalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">invalid</span>


<span class="c1"># Singleton Workspace object</span>
<span class="c1"># Must be instantiated after all of the Metatlas Objects</span>
<span class="c1"># are defined so we can get all of the subclasses.</span>
<span class="n">workspace</span> <span class="o">=</span> <span class="n">Workspace</span><span class="p">()</span>


<div class="viewcode-block" id="to_dataframe"><a class="viewcode-back" href="../../source/api/metatlas.html#metatlas.to_dataframe">[docs]</a><span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="n">objects</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a set of Metatlas objects into a dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">FETCH_STUBS</span>
    <span class="c1"># we want to handle dates, enums, and use ids for objects</span>
    <span class="n">FETCH_STUBS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">_trait_values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span> <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__class__</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">objs</span><span class="p">:</span>
        <span class="n">FETCH_STUBS</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">FETCH_STUBS</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">enums</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># remove lists and use strings for objects</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="n">trait</span><span class="p">)</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">traits</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;head_id&#39;</span><span class="p">,</span> <span class="s1">&#39;prev_uid&#39;</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">MetList</span><span class="p">):</span>
            <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="nb">str</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">unique_id</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">o</span><span class="p">[</span><span class="n">tname</span><span class="p">]]))</span>
             <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">MetInstance</span><span class="p">):</span>
            <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="n">tname</span><span class="p">],</span> <span class="s1">&#39;unique_id&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trait</span><span class="p">,</span> <span class="n">MetEnum</span><span class="p">):</span>
            <span class="n">enums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span>

    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">objs</span><span class="p">)[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cols</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">enums</span><span class="p">:</span>
        <span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;last_modified&#39;</span><span class="p">,</span> <span class="s1">&#39;creation_time&#39;</span><span class="p">]:</span>
        <span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataframe</span></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;spam&#39;</span><span class="p">)</span>
    <span class="n">store</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
    <span class="n">m1</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;baz&#39;</span>
    <span class="n">store</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">retrieve</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;spam&#39;</span><span class="p">))</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015 - 2017, Metatlas contributors.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>